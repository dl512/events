<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gathering - Weekly Activities</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 1080px;
            height: 1350px;
            background: white;
            border-radius: 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 30px 10px 30px;
            text-align: center;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 300;
            margin-bottom: 0;
            letter-spacing: 0.5px;
        }

        .activities-container {
            height: 1290px;
            overflow: hidden;
            background: white;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .activities-container.two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            align-items: stretch;
        }

        .activity-column {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .two-columns .activity-column {
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }

        .two-columns .activity-item {
            flex: 1;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 25px;
            border-bottom: 0.3px solid #ecf0f1;
            transition: background-color 0.2s ease;
            min-height: 100px;
            flex-shrink: 0;
        }

        .two-columns .activity-item {
            border-right: 0.3px solid #ecf0f1;
            min-height: 100px;
        }

        .two-columns .activity-item:nth-child(odd) {
            border-right: 0.3px solid #ecf0f1;
        }

        .two-columns .activity-item:nth-child(even) {
            border-right: none;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item:hover {
            background-color: #f8f9fa;
        }

        .date-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            gap: 3px;
            width: 100px;
            min-height: 60px;
            flex-shrink: 0;
        }

        .date-container.multiple {
            gap: 2px;
            flex-wrap: nowrap;
        }

        .date-section {
            width: 50px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        .date-section.multiple {
            width: 35px;
        }

        .date-section.multiple .date-number {
            font-size: 1.4rem;
        }

        .date-section.multiple .date-month {
            font-size: 0.7rem;
        }

        .date-separator {
            font-size: 1.2rem;
            color: #7f8c8d;
            font-weight: 300;
            margin: 0 1px;
            align-self: center;
        }

        .date-number {
            font-size: 1.8rem;
            font-weight: 300;
            color: #2c3e50;
            line-height: 1.1;
            margin-bottom: 2px;
            word-wrap: break-word;
        }

        .date-month {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 400;
            line-height: 1.1;
        }

        .activity-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-width: 0;
            padding-top: 5px;
        }

        .activity-title {
            font-size: 1.8rem;
            font-weight: 500;
            color: #2c3e50;
            line-height: 1.3;
            margin-bottom: 4px;
            word-wrap: break-word;
            max-width: 100%;
        }

        .activity-title.compact {
            font-size: 1.6rem;
        }

        .activity-title.very-compact {
            font-size: 1.2rem;
        }

        .activity-org {
            font-size: 1.4rem;
            color: #7f8c8d;
            font-weight: 400;
            margin-bottom: 3px;
            word-wrap: break-word;
            max-width: 100%;
        }

        .activity-org.compact {
            font-size: 1.3rem;
        }

        .activity-org.very-compact {
            font-size: 1.1rem;
        }

        .activity-venue {
            font-size: 1.5rem;
            color: #34495e;
            font-weight: 400;
            line-height: 1.3;
            word-wrap: break-word;
            max-width: 100%;
        }

        .activity-venue.compact {
            font-size: 1.4rem;
        }

        .activity-venue.very-compact {
            font-size: 1.2rem;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .error {
            text-align: center;
            padding: 60px;
            color: #e74c3c;
            font-size: 1.1rem;
        }

        .category-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 280px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .no-print {
            display: none !important;
        }

        .category-selector h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2rem;
        }

        .category-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .category-btn {
            padding: 10px 15px;
            border: 2px solid #ecf0f1;
            background: white;
            color: #2c3e50;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            text-align: left;
        }

        .category-btn:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .category-btn.active {
            border-color: #2c3e50;
            background: #2c3e50;
            color: white;
        }

        .download-btn {
            margin-top: 15px;
            padding: 12px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            width: 100%;
            transition: background 0.2s ease;
        }

        .download-btn:hover {
            background: #219a52;
        }

        .download-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .dark-mode-btn {
            margin-top: 10px;
            padding: 10px 15px;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            width: 100%;
            transition: background 0.2s ease;
        }

        .dark-mode-btn:hover {
            background: #2c3e50;
        }

        .dark-mode-btn.active {
            background: #e74c3c;
        }

        .dark-mode-btn.active:hover {
            background: #c0392b;
        }

        /* Dark mode styles */
        .dark-mode .container {
            background: #1a1a1a;
            color: #ffffff;
        }

        .dark-mode .header {
            background: #000000;
            color: #ffffff;
        }

        .dark-mode .activities-container {
            background: #1a1a1a;
        }

        .dark-mode .activity-item {
            background: #1a1a1a;
            border-bottom-color: #333333;
        }

        .dark-mode .two-columns .activity-item {
            border-right-color: #333333;
        }

        .dark-mode .activity-item:hover {
            background-color: #2a2a2a;
        }

        .dark-mode .activity-title {
            color: #ffffff;
        }

        .dark-mode .activity-org {
            color: #b0b0b0;
        }

        .dark-mode .activity-venue {
            color: #d0d0d0;
        }

        .dark-mode .date-number {
            color: #ffffff;
        }

        .dark-mode .date-month {
            color: #b0b0b0;
        }

        .dark-mode .date-separator {
            color: #b0b0b0;
        }

        /* Remove responsive design for fixed Instagram dimensions */
        @media (max-width: 1200px) {
            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="category-selector">
        <h3>Select Category</h3>
        <div class="category-buttons" id="categoryButtons">
            <div class="loading">Loading categories...</div>
        </div>
        <button class="download-btn" id="downloadBtn" disabled>Download Image</button>
        <button class="dark-mode-btn" id="darkModeBtn">🌙 Dark Mode</button>
    </div>

    <div class="container">
        <div class="header">
            <h1 id="categoryTitle">Loading...</h1>
        </div>
        
        <div class="activities-container" id="activitiesContainer">
            <div class="activity-column" id="leftColumn"></div>
            <div class="activity-column" id="rightColumn"></div>
        </div>
    </div>

    <script src="data-fetcher.js"></script>
    <script>
        // Global variables for data
        let allActivities = [];
        let currentCategory = "Halloween特備節目";
        let availableCategories = [];
        let isDarkMode = false;

        function parseDate(dateStr) {
            // Handle date ranges and multiple dates - keep consistent format
            let displayDate = '';
            let displayMonth = '';
            
            if (dateStr.includes('-')) {
                // Handle range like "31/10-2/11"
                const [startDate, endDate] = dateStr.split('-');
                const [startDay, startMonth] = startDate.split('/');
                const [endDay, endMonth] = endDate.split('/');
                
                if (startMonth === endMonth) {
                    // Same month: "31-2/10" -> "31-2" + "OCT"
                    displayDate = `${startDay}-${endDay}`;
                    displayMonth = getMonthName(startMonth);
                } else {
                    // Different months: "31/10-2/11" -> "31" + "OCT" then "2" + "NOV"
                    // For now, show the first date, but we'll need to handle this differently
                    displayDate = `${startDay}`;
                    displayMonth = getMonthName(startMonth);
                }
            } else if (dateStr.includes(',')) {
                // Handle multiple dates like "1/11, 15/11"
                const dates = dateStr.split(',').map(d => d.trim());
                if (dates.length === 2) {
                    const [firstDate, secondDate] = dates;
                    const [firstDay, firstMonth] = firstDate.split('/');
                    const [secondDay, secondMonth] = secondDate.split('/');
                    
                    if (firstMonth === secondMonth) {
                        // Same month: "1, 15/11" -> "1, 15" + "NOV"
                        displayDate = `${firstDay}, ${secondDay}`;
                        displayMonth = getMonthName(firstMonth);
                    } else {
                        // Different months: "1/10, 15/11" -> "1" + "OCT" then "15" + "NOV"
                        // For now, show the first date
                        displayDate = `${firstDay}`;
                        displayMonth = getMonthName(firstMonth);
                    }
                } else {
                    // More than 2 dates, just show the first one
                    const [day, month] = dates[0].split('/');
                    displayDate = day;
                    displayMonth = getMonthName(month);
                }
            } else {
                // Single date
                const [day, month] = dateStr.split('/');
                displayDate = day;
                displayMonth = getMonthName(month);
            }
            
            return {
                day: displayDate,
                month: displayMonth
            };
        }
        
        function getMonthName(month) {
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                              'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            return monthNames[parseInt(month) - 1];
        }

        function createActivityItem(activity) {
            const item = document.createElement('div');
            item.className = 'activity-item';
            
            // Parse the date and create date sections with separators
            const dateInfo = parseDateForDisplay(activity.dateStr || activity.date || '');
            
            let dateHTML = '';
            if (dateInfo.sections.length === 1) {
                // Single date
                dateHTML = `
                    <div class="date-section">
                        <div class="date-number">${dateInfo.sections[0].day}</div>
                        <div class="date-month">${dateInfo.sections[0].month}</div>
                    </div>
                `;
            } else {
                // Multiple dates - show them horizontally as "28 OCT - 8 NOV"
                const dateParts = dateInfo.sections.map((dateSection, index) => {
                    let part = `${dateSection.day} ${dateSection.month}`;
                    if (index < dateInfo.sections.length - 1) {
                        part += ` ${dateSection.separator}`;
                    }
                    return part;
                }).join(' ');
                
                dateHTML = `
                    <div class="date-section multiple" style="width: 100%; text-align: center;">
                        <div class="date-number" style="font-size: 1.2rem; line-height: 1.2;">${dateParts}</div>
                    </div>
                `;
            }
            
            const containerClass = dateInfo.sections.length > 1 ? 'date-container multiple' : 'date-container';
            
            item.innerHTML = `
                <div class="${containerClass}">
                    ${dateHTML}
                </div>
                <div class="activity-content">
                    <div class="activity-title">${activity.title}</div>
                    <div class="activity-org">@${activity.organization || 'unknown'}</div>
                    <div class="activity-venue">${activity.venue}</div>
                </div>
            `;
            
            return item;
        }
        
        function parseDateForDisplay(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') {
                return { sections: [{ day: 'N/A', month: 'N/A', separator: '' }], separator: '' };
            }
            
            const sections = [];
            let separator = '';
            
            if (dateStr.includes('-')) {
                // Handle range like "31/10-2/11" - show as horizontal layout
                const [startDate, endDate] = dateStr.split('-');
                const [startDay, startMonth] = startDate.split('/');
                const [endDay, endMonth] = endDate.split('/');
                
                separator = '-';
                
                if (startMonth === endMonth) {
                    // Same month: "31-2 OCT" (single section)
                    sections.push({
                        day: `${startDay}-${endDay}`,
                        month: getMonthName(startMonth),
                        separator: ''
                    });
                } else {
                    // Different months: "31 OCT - 2 NOV" (two sections)
                    sections.push({
                        day: startDay,
                        month: getMonthName(startMonth),
                        separator: '-'
                    });
                    sections.push({
                        day: endDay,
                        month: getMonthName(endMonth),
                        separator: ''
                    });
                }
                
            } else if (dateStr.includes(',')) {
                // Handle multiple dates like "1/11, 15/11" - show as horizontal layout
                const dates = dateStr.split(',').map(d => d.trim());
                separator = ',';
                
                dates.forEach((date, index) => {
                    const [day, month] = date.split('/');
                    sections.push({
                        day: day,
                        month: getMonthName(month),
                        separator: index < dates.length - 1 ? ',' : ''
                    });
                });
            } else {
                // Single date
                const [day, month] = dateStr.split('/');
                sections.push({
                    day: day,
                    month: getMonthName(month),
                    separator: ''
                });
            }
            
            return {
                sections: sections,
                separator: separator
            };
        }

        async function loadDataFromGoogleSheets() {
            try {
                console.log('Loading data from Google Sheets...');
                allActivities = await loadAllData();
                console.log('Loaded activities:', allActivities.length);
                
                // Extract all unique categories
                const categorySet = new Set();
                allActivities.forEach(activity => {
                    if (activity.categories) {
                        activity.categories.forEach(category => categorySet.add(category));
                    }
                });
                availableCategories = Array.from(categorySet).sort();
                console.log('Available categories:', availableCategories);
                
                // Create category buttons
                createCategoryButtons();
                
                // Filter activities by category
                const filteredActivities = allActivities.filter(activity => 
                    activity.categories && activity.categories.includes(currentCategory)
                );
                
                console.log(`Found ${filteredActivities.length} activities for category: ${currentCategory}`);
                console.log('Filtered activities:', filteredActivities);
                return filteredActivities;
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                return [];
            }
        }

        function createCategoryButtons() {
            const buttonsContainer = document.getElementById('categoryButtons');
            buttonsContainer.innerHTML = '';
            
            // Create a map of categories with their order from column F
            const categoryOrderMap = new Map();
            
            allActivities.forEach(activity => {
                if (activity.categories && activity.categories.length > 0) {
                    const category = activity.categories[0];
                    const order = activity.categoryOrder || 999;
                    
                    // Keep the lowest order number for each category
                    if (!categoryOrderMap.has(category) || categoryOrderMap.get(category) > order) {
                        categoryOrderMap.set(category, order);
                    }
                }
            });
            
            // Sort categories by their order from column F
            const sortedCategories = Array.from(categoryOrderMap.entries())
                .sort((a, b) => a[1] - b[1]) // Sort by order number
                .map(entry => entry[0]); // Extract category names
            
            console.log('Categories sorted by column F order:', sortedCategories);
            
            sortedCategories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.textContent = category;
                if (category === currentCategory) {
                    button.classList.add('active');
                }
                button.onclick = () => selectCategory(category);
                buttonsContainer.appendChild(button);
            });
        }

        async function selectCategory(category) {
            currentCategory = category;
            document.getElementById('categoryTitle').textContent = category;
            
            // Update active button
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === category) {
                    btn.classList.add('active');
                }
            });
            
            // Filter and display activities
            const filteredActivities = allActivities.filter(activity => 
                activity.categories && activity.categories.includes(category)
            );
            
            displayActivities(filteredActivities);
            
            // Enable download button
            document.getElementById('downloadBtn').disabled = false;
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const container = document.querySelector('.container');
            const darkModeBtn = document.getElementById('darkModeBtn');
            
            if (isDarkMode) {
                container.classList.add('dark-mode');
                darkModeBtn.textContent = '☀️ Light Mode';
                darkModeBtn.classList.add('active');
            } else {
                container.classList.remove('dark-mode');
                darkModeBtn.textContent = '🌙 Dark Mode';
                darkModeBtn.classList.remove('active');
            }
        }

        async function downloadImage() {
            try {
                // Load html2canvas if not already loaded
                if (typeof html2canvas === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => script.onload = resolve);
                }
                
                // Hide category selector for image generation
                const selector = document.querySelector('.category-selector');
                selector.classList.add('no-print');
                
                // Apply dynamic font sizing based on content
                applyDynamicFontSizing();
                
                const container = document.querySelector('.container');
                const canvas = await html2canvas(container, {
                    width: 1080,
                    height: 1350,
                    scale: 2,
                    useCORS: true
                });
                
                // Show category selector again
                selector.classList.remove('no-print');
                
                // Create download link with mode indicator
                const modeSuffix = isDarkMode ? '_dark' : '_light';
                const link = document.createElement('a');
                link.download = `${currentCategory.replace(/[^a-zA-Z0-9]/g, '_')}${modeSuffix}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
            } catch (error) {
                console.error('Error generating image:', error);
                alert('Error generating image. Please try again.');
            }
        }

        function applyDynamicFontSizing() {
            const activities = document.querySelectorAll('.activity-item');
            
            activities.forEach((activity, index) => {
                const title = activity.querySelector('.activity-title');
                const org = activity.querySelector('.activity-org');
                const venue = activity.querySelector('.activity-venue');
                
                // Skip if any element is not found
                if (!title || !org || !venue) {
                    console.warn(`Activity ${index} missing elements, skipping font sizing`);
                    return;
                }
                
                // Reset all classes and inline styles first
                title.className = 'activity-title';
                org.className = 'activity-org';
                venue.className = 'activity-venue';
                title.style.fontSize = '';
                org.style.fontSize = '';
                venue.style.fontSize = '';
                
                // Get the available height for this activity item
                const activityHeight = activity.offsetHeight;
                const availableHeight = activityHeight - 24; // Account for reduced padding (12px top + 12px bottom)
                
                // Debug logging
                console.log(`Activity ${index}:`, {
                    title: title.textContent.substring(0, 30) + '...',
                    titleLength: title.textContent.length,
                    activityHeight: activityHeight,
                    availableHeight: availableHeight
                });
                
                // Function to calculate content complexity (Chinese vs English ratio)
                function getContentComplexity(text) {
                    const chineseChars = (text.match(/[\u4e00-\u9fff]/g) || []).length;
                    const totalChars = text.length;
                    const chineseRatio = chineseChars / totalChars;
                    
                    // Chinese text typically needs more space
                    return chineseRatio > 0.5 ? 'high' : chineseRatio > 0.2 ? 'medium' : 'low';
                }
                
                // Function to check if content fits with better measurement
                function checkFit() {
                    // Force a reflow to get accurate measurements
                    activity.offsetHeight;
                    
                    const titleHeight = title.scrollHeight;
                    const orgHeight = org.scrollHeight;
                    const venueHeight = venue.scrollHeight;
                    
                    // Add extra space for Chinese text
                    const titleComplexity = getContentComplexity(title.textContent);
                    const orgComplexity = getContentComplexity(org.textContent);
                    const venueComplexity = getContentComplexity(venue.textContent);
                    
                    let extraSpace = 0;
                    if (titleComplexity === 'high') extraSpace += 3;
                    if (orgComplexity === 'high') extraSpace += 2;
                    if (venueComplexity === 'high') extraSpace += 3;
                    
                    const totalContentHeight = titleHeight + orgHeight + venueHeight + 10 + extraSpace; // Reduced margins
                    
                    console.log(`Activity ${index} fit check:`, {
                        titleHeight,
                        orgHeight,
                        venueHeight,
                        totalContentHeight,
                        availableHeight,
                        fits: totalContentHeight <= availableHeight
                    });
                    
                    return totalContentHeight <= availableHeight;
                }
                
                // Start with normal size and only reduce if absolutely necessary
                const sizes = [
                    { name: 'normal', title: '1.8rem', org: '1.4rem', venue: '1.5rem' },
                    { name: 'compact', title: '1.6rem', org: '1.3rem', venue: '1.4rem' },
                    { name: 'very-compact', title: '1.4rem', org: '1.1rem', venue: '1.2rem' },
                    { name: 'extra-small', title: '1.2rem', org: '1.0rem', venue: '1.1rem' },
                    { name: 'tiny', title: '1.0rem', org: '0.9rem', venue: '1.0rem' }
                ];
                
                // Try normal size first
                title.style.fontSize = sizes[0].title;
                org.style.fontSize = sizes[0].org;
                venue.style.fontSize = sizes[0].venue;
                
                // Only reduce if it doesn't fit
                if (!checkFit()) {
                    for (let i = 1; i < sizes.length; i++) {
                        const size = sizes[i];
                        
                        // Apply the font sizes
                        title.style.fontSize = size.title;
                        org.style.fontSize = size.org;
                        venue.style.fontSize = size.venue;
                        
                        // Check if it fits
                        if (checkFit()) {
                            console.log(`Activity ${index} using size: ${size.name}`);
                            break;
                        }
                    }
                } else {
                    console.log(`Activity ${index} using size: normal`);
                }
            });
        }

        function displayActivities(activities = []) {
            const container = document.getElementById('activitiesContainer');
            const leftColumn = document.getElementById('leftColumn');
            const rightColumn = document.getElementById('rightColumn');
            
            // Clear existing content
            leftColumn.innerHTML = '';
            rightColumn.innerHTML = '';
            
            if (activities.length === 0) {
                leftColumn.innerHTML = '<div class="loading">No activities found for this category</div>';
                return;
            }
            
            // Determine layout based on number of activities
            const activityCount = activities.length;
            const useTwoColumns = activityCount >= 10; // Use two columns for 10+ activities
            
            console.log(`Activity count: ${activityCount}, using two columns: ${useTwoColumns}`);
            
            if (useTwoColumns) {
                container.classList.add('two-columns');
                
                // Create all activity items first
                const items = [];
                activities.forEach((activity, index) => {
                    console.log('Creating activity', index, activity.title);
                    try {
                        const item = createActivityItem(activity);
                        items.push(item);
                    } catch (error) {
                        console.error('Error creating activity item:', error, activity);
                    }
                });
                
                // Distribute items to balance columns
                const leftItems = [];
                const rightItems = [];
                
                // Calculate how many items each column should have
                const totalItems = items.length;
                const itemsPerColumn = Math.ceil(totalItems / 2);
                
                // Distribute items
                items.forEach((item, index) => {
                    if (index < itemsPerColumn) {
                        leftItems.push(item);
                    } else {
                        rightItems.push(item);
                    }
                });
                
                // Add empty placeholder if right column has fewer items
                while (rightItems.length < leftItems.length) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'activity-item';
                    emptyItem.style.visibility = 'hidden';
                    rightItems.push(emptyItem);
                }
                
                // Add items to columns
                leftItems.forEach(item => leftColumn.appendChild(item));
                rightItems.forEach(item => rightColumn.appendChild(item));
                
            } else {
                container.classList.remove('two-columns');
                
                // Single column layout - put all activities in left column
                activities.forEach((activity, index) => {
                    console.log('Creating activity', index, activity.title);
                    try {
                        const item = createActivityItem(activity);
                        leftColumn.appendChild(item);
                    } catch (error) {
                        console.error('Error creating activity item:', error, activity);
                    }
                });
            }
            
            // Apply dynamic font sizing after all items are created
            setTimeout(() => {
                applyDynamicFontSizing();
            }, 100);
        }

        // Load and display activities on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Update header with category name
            document.getElementById('categoryTitle').textContent = currentCategory;
            
            // Set up buttons
            document.getElementById('downloadBtn').onclick = downloadImage;
            document.getElementById('darkModeBtn').onclick = toggleDarkMode;
            
            const activities = await loadDataFromGoogleSheets();
            displayActivities(activities);
        });
    </script>
</body>
</html>
